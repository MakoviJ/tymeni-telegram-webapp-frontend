<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∏ - –ú–µ–Ω—ñ, –Ø - —Ç–æ–±—ñ</title>
    <!-- –ü–Ü–î–ö–õ–Æ–ß–ê–Ñ–ú–û SDK –ü–ï–†–®–ò–ú -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –≤—Å—ñ—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            text-align: center;
            padding: 20px;
            /* NEW: –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–Ω–∏–∑—É, —â–æ–± –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞–≤—Å—è –ø–∞–Ω–µ–ª–ª—é –ª–æ–∫–∞—Ü—ñ—ó */
            padding-bottom: 70px; 
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: background-color 0.3s, color 0.3s;
        }
        h1 { margin-top: 30px; }
        .btn {
            display: block;
            width: 80%;
            margin: 15px auto;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            background-color: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
        }
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –µ–∫—Ä–∞–Ω–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        #welcome-screen, #main-menu, #create-service-form {
            display: none;
        }

        /* NEW: –°—Ç–∏–ª—ñ –¥–ª—è –ø–∞–Ω–µ–ª—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó */
        #location-display {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #888888);
            border-top: 1px solid var(--tg-theme-hint-color, #cccccc);
            z-index: 100;
        }
        .change-location-btn {
            background: none;
            border: none;
            color: var(--tg-theme-link-color, #2481cc);
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 5px;
            font-weight: 500;
        }
        .change-location-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .change-location-btn svg {
            margin-right: 4px;
            fill: currentColor;
        }
    </style>
</head>
<body>

    <h1>üíôüíõ –¢–∏ - –ú–µ–Ω—ñ, –Ø - —Ç–æ–±—ñ üíôüíõ</h1>

    <div id="welcome-screen">
        <p>–í—ñ—Ç–∞—î–º–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ! –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É —Ç–∞ –º—ñ—Å—Ç–æ, —â–æ–± –ø–æ—á–∞—Ç–∏.</p>
        <div class="form-group">
            <label for="country-select">–ö—Ä–∞—ó–Ω–∞:</label>
            <select id="country-select" onchange="updateCities()"></select>
        </div>
        <div class="form-group">
            <label for="city-select">–ú—ñ—Å—Ç–æ:</label>
            <select id="city-select"></select>
        </div>
        <button class="btn" onclick="saveUserLocation()">–ü–æ—ó—Ö–∞–ª–∏!</button>
    </div>

    <div id="main-menu">
        <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ—Å–ª—É–≥ –°–≤–æ—ó –¥–ª—è –°–≤–æ—ó—Ö</p>
        <button class="btn" onclick="tg.showAlert('–¶–µ–π —Ä–æ–∑–¥—ñ–ª —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ!')">üîç –ó–Ω–∞–π—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
        <button class="btn" onclick="showCreateForm()">‚ú® –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
        <button class="btn" onclick="tg.showAlert('–¶–µ–π —Ä–æ–∑–¥—ñ–ª —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ!')">üìû –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</button>
    </div>

    <div id="create-service-form">
        <h2>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h2>
        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="title" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –ø–æ—Å–ª—É–≥–∏" required>
        </div>
        <div class="form-group">
            <label for="description">–û–ø–∏—Å:</label>
            <textarea id="description" placeholder="–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –ø–æ—Å–ª—É–≥—É" rows="4"></textarea>
        </div>
        <div class="form-group">
            <label for="category-select">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
            <select id="category-select" onchange="updateSubcategories()"></select>
        </div>
        <div class="form-group">
            <label for="subcategory-select">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
            <select id="subcategory-select"></select>
        </div>
        <button class="btn" onclick="submitService()">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        <button class="btn" onclick="showMainMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- NEW: –ë–ª–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –ª–æ–∫–∞—Ü—ñ—ó -->
    <div id="location-display" style="display: none;">
        <span id="location-text"></span>
        <button onclick="changeLocation()" class="change-location-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3.086L6.5 11.828 8.172 10.155l6.62-6.619zM5 12.586 2.414 10 4.172 8.328 2 6.155 3.845 4l6.328 6.328-2.586 2.586z"/>
            </svg>
            <span>–ó–º—ñ–Ω–∏—Ç–∏</span>
        </button>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        const WORKER_URL = 'https://tymeni-telegram-backend.team-tymeni.workers.dev';
        const countryCityData = {
            '–°–ª–æ–≤–µ–Ω—ñ—è': ['–õ—é–±–ª—è–Ω–∞', '–ú–∞—Ä–∏–±–æ—Ä', '–ö—Ä–∞–Ω—å', '–¶–µ–ª—î', '–ö–æ–ø–µ—Ä', '–Ü–∑–æ–ª–∞', '–ü—ñ—Ä–∞–Ω', '–õ–æ–≥–∞—Ç–µ—Ü—å', '–ü–æ—Å—Ç–æ–π–Ω–∞'],
            '–ü–æ–ª—å—â–∞': ['–í–∞—Ä—à–∞–≤–∞', '–í—Ä–æ—Ü–ª–∞–≤', '–ö—Ä–∞–∫—ñ–≤', '–ü–æ–∑–Ω–∞–Ω—å', '–ì–¥–∞–Ω—Å—å–∫', '–õ–æ–¥–∑—å', '–ö–∞—Ç–æ–≤—ñ—Ü–µ', '–ì–¥–∏–Ω—è', '–°–æ–ø–æ—Ç']
        };
        let allCategories = {};
        let userCountry = null;
        let userCity = null;
        let tg;

        // NEW: –û—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó
        const locationDisplay = document.getElementById('location-display');
        const locationText = document.getElementById('location-text');

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
        function showScreen(screenId) {
            const screens = ['welcome-screen', 'main-menu', 'create-service-form'];
            screens.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(screenId).style.display = 'block';

            // NEW: –õ–æ–≥—ñ–∫–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∞–Ω–µ–ª—ñ –ª–æ–∫–∞—Ü—ñ—ó
            if (screenId === 'main-menu' || screenId === 'create-service-form') {
                updateLocationDisplay();
                locationDisplay.style.display = 'flex';
            } else {
                locationDisplay.style.display = 'none';
            }
        }

        // NEW: –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –ª–æ–∫–∞—Ü—ñ—ó
        function updateLocationDisplay() {
            if (userCountry && userCity) {
                locationText.textContent = `–í–∞—à–∞ –ª–æ–∫–∞—Ü—ñ—è: ${userCountry}, ${userCity}`;
            }
        }
        
        // NEW: –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –∑–º—ñ–Ω–∏ –ª–æ–∫–∞—Ü—ñ—ó
        function changeLocation() {
            populateCountries(); // –ü–µ—Ä–µ–∑–∞–ø–æ–≤–Ω—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫—Ä–∞—ó–Ω –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω—å
            showScreen('welcome-screen');
        }

        function updateCities() {
            const countrySelect = document.getElementById('country-select');
            const citySelect = document.getElementById('city-select');
            const selectedCountry = countrySelect.value;
            citySelect.innerHTML = '';
            if (countryCityData[selectedCountry]) {
                countryCityData[selectedCountry].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        function populateCountries() {
            const countrySelect = document.getElementById('country-select');
            // –û—á–∏—â—É—î–º–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –≤–∏–∫–ª–∏–∫—É
            countrySelect.innerHTML = '<option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É</option>';
            for (const country in countryCityData) {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            }
            updateCities();
        }

        async function checkUserStatus() {
            try {
                const response = await fetch(`${WORKER_URL}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                const user = await response.json();

                if (user.country && user.city) {
                    userCountry = user.country;
                    userCity = user.city;
                    showScreen('main-menu');
                } else {
                    populateCountries();
                    showScreen('welcome-screen');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', error);
            }
        }

        async function saveUserLocation() {
            const country = document.getElementById('country-select').value;
            const city = document.getElementById('city-select').value;
            if (!country || !city) {
                tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É —Ç–∞ –º—ñ—Å—Ç–æ.');
                return;
            }
            try {
                const response = await fetch(`${WORKER_URL}/api/users/location`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        country: country,
                        city: city
                    })
                });
                if (response.ok) {
                    userCountry = country;
                    userCity = city;
                    tg.showPopup({
                        title: '–£—Å–ø—ñ—Ö!',
                        message: `–í–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è (${country}, ${city}) –∑–±–µ—Ä–µ–∂–µ–Ω–æ.`,
                        buttons: [{id: 'ok', text: 'OK'}]
                    }, () => showScreen('main-menu'));
                } else {
                    tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó:', error);
            }
        }

        async function loadCategories() {
            if (Object.keys(allCategories).length > 0) return;
            try {
                const response = await fetch(`${WORKER_URL}/api/categories`);
                allCategories = await response.json();
                const categorySelect = document.getElementById('category-select');
                categorySelect.innerHTML = '';
                for (const key in allCategories) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = allCategories[key].name;
                    categorySelect.appendChild(option);
                }
                updateSubcategories();
            } catch (error) {
                tg.showAlert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:', error);
            }
        }

        function updateSubcategories() {
            const categorySelect = document.getElementById('category-select');
            const subcategorySelect = document.getElementById('subcategory-select');
            const selectedCategoryKey = categorySelect.value;
            subcategorySelect.innerHTML = '';
            if (allCategories[selectedCategoryKey]) {
                allCategories[selectedCategoryKey].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        function showCreateForm() {
            loadCategories();
            showScreen('create-service-form');
        }

        function showMainMenu() {
            showScreen('main-menu');
        }

        async function submitService() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category-select').value;
            const subcategory = document.getElementById('subcategory-select').value;

            if (!title || !category || !subcategory) {
                tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.');
                return;
            }

            try {
                const response = await fetch(`${WORKER_URL}/api/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        title,
                        description,
                        category,
                        subcategory,
                        country: userCountry,
                        city: userCity
                    })
                });

                if (response.ok) {
                    tg.showPopup({
                        title: '–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!',
                        message: `–í–∞—à–∞ –ø–æ—Å–ª—É–≥–∞ "${title}" —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∞.`,
                        buttons: [{id: 'ok', text: 'OK'}]
                    }, () => {
                        document.getElementById('title').value = '';
                        document.getElementById('description').value = '';
                        showMainMenu();
                    });
                } else {
                    tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();

                checkUserStatus();

            } else {
                console.error("Telegram WebApp SDK –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.");
                document.body.innerHTML = '<h1>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É</h1><p>–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –π–æ–≥–æ –≤ Telegram.</p>';
            }
        });
    </script>
</body>
</html>


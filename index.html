<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∏ - –ú–µ–Ω—ñ, –Ø - —Ç–æ–±—ñ</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –≤—Å—ñ—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; 
            text-align: center; 
            padding: 20px; 
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: background-color 0.3s, color 0.3s;
        }
        h1 { margin-top: 30px; }
        .btn { 
            display: block; 
            width: 80%; 
            margin: 15px auto; 
            padding: 15px; 
            border: none; 
            border-radius: 10px; 
            font-size: 18px; 
            font-weight: bold; 
            background-color: var(--tg-theme-button-color, #40a7e3); 
            color: var(--tg-theme-button-text-color, #ffffff); 
            cursor: pointer; 
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
        }
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –µ–∫—Ä–∞–Ω–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        #welcome-screen, #main-menu, #create-service-form {
            display: none;
        }
    </style>
</head>
<body>

    <h1>üíôüíõ –¢–∏ - –ú–µ–Ω—ñ, –Ø - —Ç–æ–±—ñ üíôüíõ</h1>

    <div id="welcome-screen">
        <p>–í—ñ—Ç–∞—î–º–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ! –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É —Ç–∞ –º—ñ—Å—Ç–æ, —â–æ–± –ø–æ—á–∞—Ç–∏.</p>
        <div class="form-group">
            <label for="country-select">–ö—Ä–∞—ó–Ω–∞:</label>
            <select id="country-select" onchange="updateCities()"></select>
        </div>
        <div class="form-group">
            <label for="city-select">–ú—ñ—Å—Ç–æ:</label>
            <select id="city-select"></select>
        </div>
        <button class="btn" onclick="saveUserLocation()">–ü–æ—ó—Ö–∞–ª–∏!</button>
    </div>

    <div id="main-menu">
        <p>–ü–ª–∞—Ç—Ñ–æ—Ä–º–∞ –ø–æ—Å–ª—É–≥ –°–≤–æ—ó –¥–ª—è –°–≤–æ—ó—Ö</p>
        <button class="btn" onclick="alert('–¶–µ–π —Ä–æ–∑–¥—ñ–ª —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ!')">üîç –ó–Ω–∞–π—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
        <button class="btn" onclick="showCreateForm()">‚ú® –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
        <button class="btn" onclick="alert('–¶–µ–π —Ä–æ–∑–¥—ñ–ª —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ!')">üìû –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</button>
    </div>

    <div id="create-service-form">
        <h2>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h2>
        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="title" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –ø–æ—Å–ª—É–≥–∏" required>
        </div>
        <div class="form-group">
            <label for="description">–û–ø–∏—Å:</label>
            <textarea id="description" placeholder="–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –ø–æ—Å–ª—É–≥—É" rows="4"></textarea>
        </div>
        <div class="form-group">
            <label for="category-select">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
            <select id="category-select" onchange="updateSubcategories()"></select>
        </div>
        <div class="form-group">
            <label for="subcategory-select">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
            <select id="subcategory-select"></select>
        </div>
        <button class="btn" onclick="submitService()">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        <button class="btn" onclick="showMainMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        const WORKER_URL = 'https://tymeni-telegram-backend.team-tymeni.workers.dev';

        // –î–∞–Ω—ñ –¥–ª—è –≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Å–ø–∏—Å–∫—ñ–≤ (—É –º–∞–π–±—É—Ç–Ω—å–æ–º—É –º–æ–∂–Ω–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂—É–≤–∞—Ç–∏ –∑ API)
        const countryCityData = {
            '–£–∫—Ä–∞—ó–Ω–∞': ['–ö–∏—ó–≤', '–õ—å–≤—ñ–≤', '–•–∞—Ä–∫—ñ–≤', '–û–¥–µ—Å–∞'],
            '–ü–æ–ª—å—â–∞': ['–í–∞—Ä—à–∞–≤–∞', '–ö—Ä–∞–∫—ñ–≤', '–í—Ä–æ—Ü–ª–∞–≤', '–ì–¥–∞–Ω—Å—å–∫']
        };
        let allCategories = {}; // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ç—É—Ç –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –∑ –±–µ–∫–µ–Ω–¥—É
        let userCountry = null;
        let userCity = null;

        tg.ready();
        tg.expand();
        tg.enableClosingConfirmation();

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –ø–µ–≤–Ω–æ–≥–æ –µ–∫—Ä–∞–Ω—É
        function showScreen(screenId) {
            const screens = ['welcome-screen', 'main-menu', 'create-service-form'];
            screens.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            document.getElementById(screenId).style.display = 'block';
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –º—ñ—Å—Ç –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –æ–±—Ä–∞–Ω–æ—ó –∫—Ä–∞—ó–Ω–∏
        function updateCities() {
            const countrySelect = document.getElementById('country-select');
            const citySelect = document.getElementById('city-select');
            const selectedCountry = countrySelect.value;
            citySelect.innerHTML = '';
            if (countryCityData[selectedCountry]) {
                countryCityData[selectedCountry].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –≤–∏–ø–∞–¥–∞—é—á–∏—Ö —Å–ø–∏—Å–∫—ñ–≤ –∫—Ä–∞—ó–Ω
        function populateCountries() {
            const countrySelect = document.getElementById('country-select');
            for (const country in countryCityData) {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            }
            updateCities();
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Å—Ç–∞–Ω—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        async function checkUserStatus() {
            try {
                const response = await fetch(`${WORKER_URL}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                const user = await response.json();

                if (user.country && user.city) {
                    userCountry = user.country;
                    userCity = user.city;
                    showScreen('main-menu');
                } else {
                    populateCountries();
                    showScreen('welcome-screen');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', error);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó
        async function saveUserLocation() {
            const country = document.getElementById('country-select').value;
            const city = document.getElementById('city-select').value;

            if (!country || !city) {
                tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É —Ç–∞ –º—ñ—Å—Ç–æ.');
                return;
            }
            
            try {
                const response = await fetch(`${WORKER_URL}/api/users/location`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        initData: tg.initData, 
                        country: country, 
                        city: city 
                    })
                });
                if (response.ok) {
                    userCountry = country;
                    userCity = city;
                    tg.showPopup({
                        title: '–£—Å–ø—ñ—Ö!',
                        message: `–í–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è (${country}, ${city}) –∑–±–µ—Ä–µ–∂–µ–Ω–æ.`,
                        buttons: [{id: 'ok', text: 'OK'}]
                    }, () => showScreen('main-menu'));
                } else {
                    tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó:', error);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π —Ç–∞ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è —Ñ–æ—Ä–º
        async function loadCategories() {
            if (Object.keys(allCategories).length > 0) return; // –ó–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –æ–¥–∏–Ω —Ä–∞–∑
            try {
                const response = await fetch(`${WORKER_URL}/api/categories`);
                allCategories = await response.json();
                const categorySelect = document.getElementById('category-select');
                categorySelect.innerHTML = '';
                for (const key in allCategories) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = allCategories[key].name;
                    categorySelect.appendChild(option);
                }
                updateSubcategories();
            } catch (error) {
                tg.showAlert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:', error);
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ–π
        function updateSubcategories() {
            const categorySelect = document.getElementById('category-select');
            const subcategorySelect = document.getElementById('subcategory-select');
            const selectedCategoryKey = categorySelect.value;
            subcategorySelect.innerHTML = '';
            if (allCategories[selectedCategoryKey]) {
                allCategories[selectedCategoryKey].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É —Ñ–æ—Ä–º–∏ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
        function showCreateForm() {
            loadCategories();
            showScreen('create-service-form');
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
        function showMainMenu() {
            showScreen('main-menu');
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è
        async function submitService() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category-select').value;
            const subcategory = document.getElementById('subcategory-select').value;

            if (!title || !category || !subcategory) {
                tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.');
                return;
            }

            try {
                const response = await fetch(`${WORKER_URL}/api/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        title,
                        description,
                        category,
                        subcategory,
                        country: userCountry,
                        city: userCity
                    })
                });
                
                if (response.ok) {
                    tg.showPopup({
                        title: '–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!',
                        message: `–í–∞—à–∞ –ø–æ—Å–ª—É–≥–∞ "${title}" —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∞.`,
                        buttons: [{id: 'ok', text: 'OK'}]
                    }, () => {
                        // –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ–æ—Ä–º—É —Ç–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
                        document.getElementById('title').value = '';
                        document.getElementById('description').value = '';
                        showMainMenu();
                    });
                } else {
                    tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó:', error);
            }
        }

        // –ü–æ—á–∏–Ω–∞—î–º–æ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
        checkUserStatus();

    </script>
</body>
</html>

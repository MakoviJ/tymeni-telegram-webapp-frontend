<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∏ - –ú–µ–Ω—ñ, –Ø - —Ç–æ–±—ñ</title>
    <!-- –ü–Ü–î–ö–õ–Æ–ß–ê–Ñ–ú–û SDK –ü–ï–†–®–ò–ú -->
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* –°—Ç–∏–ª—ñ –¥–ª—è –≤—Å—ñ—Ö –µ–∫—Ä–∞–Ω—ñ–≤ */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            text-align: center;
            padding: 20px;
            /* NEW: –î–æ–¥–∞—î–º–æ –≤—ñ–¥—Å—Ç—É–ø –∑–Ω–∏–∑—É, —â–æ–± –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä–∏–≤–∞–≤—Å—è –ø–∞–Ω–µ–ª–ª—é –ª–æ–∫–∞—Ü—ñ—ó */
            padding-bottom: 70px; 
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: background-color 0.3s, color 0.3s;
        }
        h1 { margin-top: 30px; }
        .btn {
            display: block;
            width: 80%;
            margin: 15px auto;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: bold;
            background-color: var(--tg-theme-button-color, #40a7e3);
            color: var(--tg-theme-button-text-color, #ffffff);
            cursor: pointer;
        }
        .form-group {
            margin-bottom: 15px;
            text-align: left;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
        }
        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid var(--tg-theme-hint-color, #cccccc);
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            color: var(--tg-theme-text-color, #000000);
            box-sizing: border-box;
        }
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –≤—Å—ñ –µ–∫—Ä–∞–Ω–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º */
        #welcome-screen, #main-menu, #create-service-form {
            display: none;
        }

        /* NEW: –°—Ç–∏–ª—ñ –¥–ª—è –ø–∞–Ω–µ–ª—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó */
        #location-display {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            padding: 10px 20px;
            box-sizing: border-box;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            color: var(--tg-theme-hint-color, #888888);
            border-top: 1px solid var(--tg-theme-hint-color, #cccccc);
            z-index: 100;
        }
        .change-location-btn {
            background: none;
            border: none;
            color: var(--tg-theme-link-color, #2481cc);
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
            display: flex;
            align-items: center;
            padding: 5px;
            border-radius: 5px;
            font-weight: 500;
        }
        .change-location-btn:hover {
            background-color: rgba(0,0,0,0.05);
        }
        .change-location-btn svg {
            margin-right: 4px;
            fill: currentColor;
        }
    </style>
</head>
<body>

    <style>
        .second-line {
            display: inline-block;
            margin-top: 5px;
        }
    </style>

    <h1>üíôüíõ –¢–∏ - –ú–µ–Ω—ñ,<br><span class="second-line">–Ø - –¢–æ–±—ñ</span> üíôüíõ</h1>

    <div id="welcome-screen">
        <p>–í—ñ—Ç–∞—î–º–æ –Ω–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º—ñ! –ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É —Ç–∞ –º—ñ—Å—Ç–æ, —â–æ–± –ø–æ—á–∞—Ç–∏.</p>
        <div class="form-group">
            <label for="country-select">–ö—Ä–∞—ó–Ω–∞:</label>
            <select id="country-select" onchange="updateCities()"></select>
        </div>
        <div class="form-group">
            <label for="city-select">–ú—ñ—Å—Ç–æ:</label>
            <select id="city-select"></select>
        </div>
        <button class="btn" onclick="saveUserLocation()">–ü–æ—ó—Ö–∞–ª–∏!</button>
    </div>

    <div id="main-menu">
        <p>–ú–∞–π–¥–∞–Ω—á–∏–∫ –ø–æ—Å–ª—É–≥ –¥–ª—è —É–∫—Ä–∞—ó–Ω—Ü—ñ–≤</p>
        <button class="btn" onclick="showSearchScreen()">üîç –ó–Ω–∞–π—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
        <button class="btn" onclick="showCreateForm()">‚ú® –ó–∞–ø—Ä–æ–ø–æ–Ω—É–≤–∞—Ç–∏ –ø–æ—Å–ª—É–≥—É</button>
        <button class="btn" onclick="tg.showAlert('–¶–µ–π —Ä–æ–∑–¥—ñ–ª —â–µ –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ!')">üìû –ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å</button>
    </div>

    <!-- –ù–û–í–ò–ô –ï–ö–†–ê–ù: –í—Å—Ç–∞–≤–ª—è—î–º–æ —Ç—É—Ç -->
    <div id="search-screen">
        <h2>üîç –ó–Ω–∞–π—Ç–∏ –ø–æ—Å–ª—É–≥—É</h2>
        
        <!-- –ê. –í–µ—Ä—Ö–Ω—è —á–∞—Å—Ç–∏–Ω–∞: –ü–æ—à—É–∫ –∑–∞ –∫–ª—é—á–æ–≤–∏–º–∏ —Å–ª–æ–≤–∞–º–∏ -->
        <div class="search-header">
            <input type="text" id="keyword-search" placeholder="üîç –ü–µ—Ä—É–∫–∞—Ä, –∫–æ—Å–º–µ—Ç–æ–ª–æ–≥, –Ω—è–Ω—è...">
        </div>
    
        <!-- –ë. –°–µ—Ä–µ–¥–Ω—è —á–∞—Å—Ç–∏–Ω–∞: –§—ñ–ª—å—Ç—Ä –ø–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—è–º -->
        <div class="category-filter">
            <div class="form-group">
                <label for="search-category-select">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
                <select id="search-category-select" onchange="updateSearchSubcategoriesWithCounts()">
                    <option value="–í—Å—ñ">–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó (<span id="all-categories-count">0</span>)</option>
                    <!-- –ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –±—É–¥—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏—Å—å —Å—é–¥–∏ JS -->
                </select>
            </div>
            
            <div class="form-group">
                <label for="search-subcategory-select">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
                <select id="search-subcategory-select">
                    <option value="–í—Å—ñ">–í—Å—ñ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>
                    <!-- –ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó –±—É–¥—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏—Å—å —Å—é–¥–∏ JS -->
                </select>
            </div>
            
            <button class="btn search-btn" onclick="performSearch()">–ü–æ–∫–∞–∑–∞—Ç–∏</button>
        </div>
    
        <!-- –í. –ù–∏–∂–Ω—è —á–∞—Å—Ç–∏–Ω–∞: –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ –ª–æ–∫–∞—Ü—ñ—é -->
        <div class="location-info">
            <small>üìç <span id="current-location-display">–ú—ñ—Å—Ç–æ –Ω–µ –æ–±—Ä–∞–Ω–æ</span> ‚Ä¢ <span id="total-ads-count">0</span> –æ–≥–æ–ª–æ—à–µ–Ω—å</small>
        </div>
    
        <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ (—Å–ø–æ—á–∞—Ç–∫—É –ø–æ—Ä–æ–∂–Ω—ñ–π) -->
        <div id="search-results" style="margin-top: 20px; text-align: left;"></div>
    
        <button class="btn" onclick="showMainMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <div id="create-service-form">
        <h2>–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏ –æ–≥–æ–ª–æ—à–µ–Ω–Ω—è</h2>
        <div class="form-group">
            <label for="title">–ó–∞–≥–æ–ª–æ–≤–æ–∫:</label>
            <input type="text" id="title" placeholder="–ö–æ—Ä–æ—Ç–∫–∏–π –æ–ø–∏—Å –ø–æ—Å–ª—É–≥–∏" required>
        </div>
        <div class="form-group">
            <label for="description">–û–ø–∏—Å:</label>
            <textarea id="description" placeholder="–î–µ—Ç–∞–ª—å–Ω–æ –æ–ø–∏—à—ñ—Ç—å –ø–æ—Å–ª—É–≥—É" rows="4"></textarea>
        </div>
        <div class="form-group">
            <label for="category-select">–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
            <select id="category-select" onchange="updateSubcategories()"></select>
        </div>
        <div class="form-group">
            <label for="subcategory-select">–ü—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—è:</label>
            <select id="subcategory-select"></select>
        </div>
        <button class="btn" onclick="submitService()">–û–ø—É–±–ª—ñ–∫—É–≤–∞—Ç–∏</button>
        <button class="btn" onclick="showMainMenu()">–ù–∞–∑–∞–¥</button>
    </div>

    <!-- NEW: –ë–ª–æ–∫ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ—ó –ª–æ–∫–∞—Ü—ñ—ó -->
    <div id="location-display" style="display: none;">
        <span id="location-text"></span>
        <button onclick="changeLocation()" class="change-location-btn">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16">
                <path d="M12.146.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1 0 .708l-10 10a.5.5 0 0 1-.168.11l-5 2a.5.5 0 0 1-.65-.65l2-5a.5.5 0 0 1 .11-.168zM11.207 2.5 13.5 4.793 14.793 3.5 12.5 1.207zm1.586 3.086L6.5 11.828 8.172 10.155l6.62-6.619zM5 12.586 2.414 10 4.172 8.328 2 6.155 3.845 4l6.328 6.328-2.586 2.586z"/>
            </svg>
            <span>–ó–º—ñ–Ω–∏—Ç–∏</span>
        </button>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ
        const WORKER_URL = 'https://tymeni-telegram-backend.team-tymeni.workers.dev';
        const countryCityData = {
            '–°–ª–æ–≤–µ–Ω—ñ—è': ['–õ—é–±–ª—è–Ω–∞', '–ú–∞—Ä–∏–±–æ—Ä', '–ö—Ä–∞–Ω—å', '–¶–µ–ª—î', '–ö–æ–ø–µ—Ä', '–Ü–∑–æ–ª–∞', '–ü—ñ—Ä–∞–Ω', '–õ–æ–≥–∞—Ç–µ—Ü—å', '–ü–æ—Å—Ç–æ–π–Ω–∞'],
            '–ü–æ–ª—å—â–∞': ['–í–∞—Ä—à–∞–≤–∞', '–í—Ä–æ—Ü–ª–∞–≤', '–ö—Ä–∞–∫—ñ–≤', '–ü–æ–∑–Ω–∞–Ω—å', '–ì–¥–∞–Ω—Å—å–∫', '–õ–æ–¥–∑—å', '–ö–∞—Ç–æ–≤—ñ—Ü–µ', '–ì–¥–∏–Ω—è', '–°–æ–ø–æ—Ç']
        };
        let allCategories = {};
        let userCountry = null;
        let userCity = null;
        let tg;

        // NEW: –û—Ç—Ä–∏–º—É—î–º–æ –¥–æ—Å—Ç—É–ø –¥–æ –µ–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó
        const locationDisplay = document.getElementById('location-display');
        const locationText = document.getElementById('location-text');

        // –§—É–Ω–∫—Ü—ñ—ó –¥–ª—è —Ä–æ–±–æ—Ç–∏ –∑ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º
        function showScreen(screenId) {
            // –ü—Ä–∏—Ö–æ–≤–∞—Ç–∏ –≤—Å—ñ –µ–∫—Ä–∞–Ω–∏
            const screens = ['welcome-screen', 'main-menu', 'create-service-form', 'search-screen'];
            screens.forEach(id => {
                document.getElementById(id).style.display = 'none';
            });
            
            // –ü–æ–∫–∞–∑–∞—Ç–∏ –ø–æ—Ç—Ä—ñ–±–Ω–∏–π –µ–∫—Ä–∞–Ω
            document.getElementById(screenId).style.display = 'block';
        
            // –õ–æ–≥—ñ–∫–∞ –¥–ª—è –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –ø–∞–Ω–µ–ª—ñ –ª–æ–∫–∞—Ü—ñ—ó
            if (screenId === 'main-menu' || screenId === 'create-service-form' || screenId === 'search-screen') {
                updateLocationDisplay();
                locationDisplay.style.display = 'flex';
            } else {
                locationDisplay.style.display = 'none';
            }
        }

        // NEW: –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É –ª–æ–∫–∞—Ü—ñ—ó
        function updateLocationDisplay() {
            if (userCountry && userCity) {
                locationText.textContent = `${userCity}, ${userCountry}`;
            }
        }
        
        // NEW: –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É –¥–æ –∑–º—ñ–Ω–∏ –ª–æ–∫–∞—Ü—ñ—ó
        function changeLocation() {
            populateCountries(); // –ü–µ—Ä–µ–∑–∞–ø–æ–≤–Ω—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫—Ä–∞—ó–Ω –Ω–∞ –≤–∏–ø–∞–¥–æ–∫ –æ–Ω–æ–≤–ª–µ–Ω—å
            showScreen('welcome-screen');
        }

        function updateCities() {
            const countrySelect = document.getElementById('country-select');
            const citySelect = document.getElementById('city-select');
            const selectedCountry = countrySelect.value;
            citySelect.innerHTML = '';
            if (countryCityData[selectedCountry]) {
                countryCityData[selectedCountry].forEach(city => {
                    const option = document.createElement('option');
                    option.value = city;
                    option.textContent = city;
                    citySelect.appendChild(option);
                });
            }
        }

        function populateCountries() {
            const countrySelect = document.getElementById('country-select');
            // –û—á–∏—â—É—î–º–æ, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—ñ–∫–∞—Ç—ñ–≤ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º—É –≤–∏–∫–ª–∏–∫—É
            countrySelect.innerHTML = '<option value="" disabled selected>–û–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É</option>';
            for (const country in countryCityData) {
                const option = document.createElement('option');
                option.value = country;
                option.textContent = country;
                countrySelect.appendChild(option);
            }
            updateCities();
        }

        async function checkUserStatus() {
            try {
                const response = await fetch(`${WORKER_URL}/api/users`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ initData: tg.initData })
                });
                const user = await response.json();

                if (user.country && user.city) {
                    userCountry = user.country;
                    userCity = user.city;
                    showScreen('main-menu');
                } else {
                    populateCountries();
                    showScreen('welcome-screen');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –±–æ—Ç–∞.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞:', error);
            }
        }

        async function saveUserLocation() {
            const country = document.getElementById('country-select').value;
            const city = document.getElementById('city-select').value;
            if (!country || !city) {
                tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å –∫—Ä–∞—ó–Ω—É —Ç–∞ –º—ñ—Å—Ç–æ.');
                return;
            }
            try {
                const response = await fetch(`${WORKER_URL}/api/users/location`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        country: country,
                        city: city
                    })
                });
                if (response.ok) {
                    userCountry = country;
                    userCity = city;
                    tg.showPopup({
                        title: '–£—Å–ø—ñ—Ö!',
                        message: `–í–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è (${country}, ${city}) –∑–±–µ—Ä–µ–∂–µ–Ω–æ.`,
                        buttons: [{id: 'ok', text: 'OK'}]
                    }, () => showScreen('main-menu'));
                } else {
                    tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è –ª–æ–∫–∞—Ü—ñ—ó:', error);
            }
        }

        async function loadCategories() {
            if (Object.keys(allCategories).length > 0) return;
            try {
                const response = await fetch(`${WORKER_URL}/api/categories`);
                allCategories = await response.json();
                const categorySelect = document.getElementById('category-select');
                categorySelect.innerHTML = '';
                for (const key in allCategories) {
                    const option = document.createElement('option');
                    option.value = key;
                    option.textContent = allCategories[key].name;
                    categorySelect.appendChild(option);
                }
                updateSubcategories();
            } catch (error) {
                tg.showAlert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π:', error);
            }
        }

        function updateSubcategories() {
            const categorySelect = document.getElementById('category-select');
            const subcategorySelect = document.getElementById('subcategory-select');
            const selectedCategoryKey = categorySelect.value;
            subcategorySelect.innerHTML = '';
            if (allCategories[selectedCategoryKey]) {
                allCategories[selectedCategoryKey].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    option.textContent = sub;
                    subcategorySelect.appendChild(option);
                });
            }
        }

        function showCreateForm() {
            loadCategories();
            showScreen('create-service-form');
        }

        function showMainMenu() {
            showScreen('main-menu');
        }

        async function submitService() {
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const category = document.getElementById('category-select').value;
            const subcategory = document.getElementById('subcategory-select').value;

            if (!title || !category || !subcategory) {
                tg.showAlert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –æ–±–æ–≤\'—è–∑–∫–æ–≤—ñ –ø–æ–ª—è.');
                return;
            }

            try {
                const response = await fetch(`${WORKER_URL}/api/services`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        initData: tg.initData,
                        title,
                        description,
                        category,
                        subcategory,
                        country: userCountry,
                        city: userCity
                    })
                });

                if (response.ok) {
                    tg.showPopup({
                        title: '–û–≥–æ–ª–æ—à–µ–Ω–Ω—è –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ!',
                        message: `–í–∞—à–∞ –ø–æ—Å–ª—É–≥–∞ "${title}" —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–∞.`,
                        buttons: [{id: 'ok', text: 'OK'}]
                    }, () => {
                        document.getElementById('title').value = '';
                        document.getElementById('description').value = '';
                        showMainMenu();
                    });
                } else {
                    tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
                }
            } catch (error) {
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑\'—î–¥–Ω–∞–Ω–Ω—è.');
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø—É–±–ª—ñ–∫–∞—Ü—ñ—ó:', error);
            }
        }

        // –ì–ª–æ–±–∞–ª—å–Ω–∞ –∑–º—ñ–Ω–Ω–∞ –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∫—ñ–ª—å–∫–æ—Å—Ç–µ–π
        let categoryCounts = {};
        
        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –ø–æ–∫–∞–∑—É –µ–∫—Ä–∞–Ω—É –ø–æ—à—É–∫—É
        async function showSearchScreen() {
            showScreen('search-screen');
            
            console.log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó:', Object.keys(allCategories).length);
            
            // –°–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó, —è–∫—â–æ —â–µ –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ
            if (Object.keys(allCategories).length === 0) {
                console.log('–ö–∞—Ç–µ–≥–æ—Ä—ñ—ó –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ, –∑–∞–≤–∞–Ω—Ç–∞–∂—É—é...');
                await loadCategories();
            }
            
            // –ü–æ—Ç—ñ–º –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏
            await loadCategoriesWithCounts();
        }
        
        // –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞–º–∏
        async function loadCategoriesWithCounts() {
            try {
                console.log('–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤ –¥–ª—è:', userCountry, userCity);
                const url = new URL(`${WORKER_URL}/api/services/counts`);
                if (userCountry) url.searchParams.append('country', userCountry);
                if (userCity) url.searchParams.append('city', userCity);
                
                console.log('URL –∑–∞–ø–∏—Ç—É:', url.toString());
                
                const response = await fetch(url);
                console.log('–°—Ç–∞—Ç—É—Å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:', response.status);
                
                categoryCounts = await response.json();
                console.log('–û—Ç—Ä–∏–º–∞–Ω—ñ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∏:', categoryCounts);
                
                populateCategoriesWithCounts();
                updateLocationInfo();
                
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ª—ñ—á–∏–ª—å–Ω–∏–∫—ñ–≤:', error);
                tg.showAlert('–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –¥–∞–Ω—ñ –¥–ª—è –ø–æ—à—É–∫—É');
            }
        }
        
        // –ó–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞–º–∏
        function populateCategoriesWithCounts() {
            const categorySelect = document.getElementById('search-category-select');
            if (!categorySelect) {
                console.error('–ï–ª–µ–º–µ–Ω—Ç search-category-select –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ!');
                return;
            }
            
            // –û—á–∏—â—É—î–º–æ, –∑–∞–ª–∏—à–∞—é—á–∏ —Ç—ñ–ª—å–∫–∏ –ø–µ—Ä—à—É –æ–ø—Ü—ñ—é "–í—Å—ñ"
            const allOption = categorySelect.querySelector('option[value="–í—Å—ñ"]');
            categorySelect.innerHTML = '';
            categorySelect.appendChild(allOption);
            
            // –û–Ω–æ–≤–ª—é—î–º–æ –ª—ñ—á–∏–ª—å–Ω–∏–∫ –¥–ª—è "–í—Å—ñ –∫–∞—Ç–µ–≥–æ—Ä—ñ—ó"
            document.getElementById('all-categories-count').textContent = categoryCounts.all || 0;
            
            // –î–æ–¥–∞—î–º–æ —Ä–µ—à—Ç—É –∫–∞—Ç–µ–≥–æ—Ä—ñ–π
            for (const key in allCategories) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = `${allCategories[key].name} (${categoryCounts[key] || 0})`;
                categorySelect.appendChild(option);
            }
        }
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ–π –∑ –ª—ñ—á–∏–ª—å–Ω–∏–∫–∞–º–∏
        function updateSearchSubcategoriesWithCounts() {
            const categorySelect = document.getElementById('search-category-select');
            const subcategorySelect = document.getElementById('search-subcategory-select');
            const selectedCategory = categorySelect.value;
            
            subcategorySelect.innerHTML = '<option value="–í—Å—ñ">–í—Å—ñ –ø—ñ–¥–∫–∞—Ç–µ–≥–æ—Ä—ñ—ó</option>';
            
            if (selectedCategory !== '–í—Å—ñ' && allCategories[selectedCategory]) {
                allCategories[selectedCategory].subcategories.forEach(sub => {
                    const option = document.createElement('option');
                    option.value = sub;
                    const countKey = `${selectedCategory}_${sub}`;
                    option.textContent = `${sub} (${categoryCounts[countKey] || 0})`;
                    subcategorySelect.appendChild(option);
                });
            }
        }
        
        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –ª–æ–∫–∞—Ü—ñ—é
        function updateLocationInfo() {
            const locationDisplay = document.getElementById('current-location-display');
            const adsCount = document.getElementById('total-ads-count');
            
            if (userCountry && userCity) {
                locationDisplay.textContent = `${userCity}, ${userCountry}`;
                adsCount.textContent = categoryCounts.all || 0;
            } else {
                locationDisplay.textContent = '–ú—ñ—Å—Ç–æ –Ω–µ –æ–±—Ä–∞–Ω–æ';
                adsCount.textContent = '0';
            }
        }

        function displaySearchResults(services) {
            const resultsContainer = document.getElementById('search-results');
            resultsContainer.innerHTML = ''; // –û—á–∏—â–∞—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
        
            if (services.length === 0) {
                resultsContainer.innerHTML = '<p style="text-align: center; padding: 20px; color: var(--tg-theme-hint-color);">–ó–∞ –≤–∞—à–∏–º –∑–∞–ø–∏—Ç–æ–º –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ.</p>';
                return;
            }
        
            services.forEach(service => {
                const serviceElement = document.createElement('div');
                serviceElement.style.border = '1px solid var(--tg-theme-hint-color, #ccc)';
                serviceElement.style.borderRadius = '10px';
                serviceElement.style.padding = '15px';
                serviceElement.style.marginBottom = '15px';
                serviceElement.style.backgroundColor = 'var(--tg-theme-secondary-bg-color, #f9f9f9)';
        
                serviceElement.innerHTML = `
                    <h3 style="margin-top: 0; color: var(--tg-theme-button-color, #40a7e3);">${service.title}</h3>
                    <p><strong>–ö–∞—Ç–µ–≥–æ—Ä—ñ—è:</strong> ${allCategories[service.category]?.name || service.category} / ${service.subcategory}</p>
                    ${service.description ? `<p><strong>–û–ø–∏—Å:</strong> ${service.description}</p>` : ''}
                    <p><strong>–õ–æ–∫–∞—Ü—ñ—è:</strong> ${service.country}, ${service.city}</p>
                    <p><strong>–í—ñ–¥:</strong> ${service.first_name} ${service.username ? '(@' + service.username + ')' : ''}</p>
                    <p><small>–û–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–æ: ${new Date(service.created_at).toLocaleDateString('uk-UA')}</small></p>
                    <button class="btn" onclick="tg.showAlert('–§—É–Ω–∫—Ü—ñ—è –∫–æ–Ω—Ç–∞–∫—Ç—É–≤–∞–Ω–Ω—è –∑ º—è–≤–∏—Ç—å—Å—è –Ω–∞–π–±–ª–∏–∂—á–∏–º —á–∞—Å–æ–º!')">üìû –ó–≤'—è–∑–∞—Ç–∏—Å—è</button>
                `;
                resultsContainer.appendChild(serviceElement);
            });
        }

        // –§—É–Ω–∫—Ü—ñ—è –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ—à—É–∫—É
        async function performSearch() {
            const keyword = document.getElementById('keyword-search').value.trim();
            const category = document.getElementById('search-category-select').value;
            const subcategory = document.getElementById('search-subcategory-select').value;
            
            // –ë—É–¥—É—î–º–æ URL –¥–ª—è –ø–æ—à—É–∫—É
            const url = new URL(`${WORKER_URL}/api/services`);
            if (userCountry && userCountry !== '–í—Å—ñ') url.searchParams.append('country', userCountry);
            if (userCity && userCity !== '–í—Å—ñ') url.searchParams.append('city', userCity);
            if (category && category !== '–í—Å—ñ') url.searchParams.append('category', category);
            if (subcategory && subcategory !== '–í—Å—ñ') url.searchParams.append('subcategory', subcategory);
            if (keyword) url.searchParams.append('search', keyword);
        
            try {
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error('–ü–æ–º–∏–ª–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞');
                }
                const services = await response.json();
                displaySearchResults(services);
            } catch (error) {
                console.error('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É:', error);
                tg.showAlert('–ü–æ–º–∏–ª–∫–∞ –ø–æ—à—É–∫—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.');
            }
        }

        // –û–±—Ä–æ–±–∫–∞ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—è Enter –≤ –ø–æ–ª—ñ –ø–æ—à—É–∫—É
        document.getElementById('keyword-search').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        document.addEventListener('DOMContentLoaded', function() {
            if (window.Telegram && window.Telegram.WebApp) {
                tg = window.Telegram.WebApp;
                
                tg.ready();
                tg.expand();
                tg.enableClosingConfirmation();

                checkUserStatus();

            } else {
                console.error("Telegram WebApp SDK –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–æ. –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è.");
                document.body.innerHTML = '<h1>–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–æ–¥–∞—Ç–∫—É</h1><p>–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ –π–æ–≥–æ –≤ Telegram.</p>';
            }
        });
    </script>
</body>
</html>

